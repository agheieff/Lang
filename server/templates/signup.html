<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign up - Arcadia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .hint{font-size:.85rem;color:#6b7280}
      /* Simple modal */
      .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
      .modal{background:#fff;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.2);max-width:420px;width:90%;padding:16px}
      .modal h2{font-size:20px;font-weight:600;margin:0 0 8px}
      .modal .row{margin:10px 0}
      .modal label{display:block;font-size:14px;margin-bottom:4px}
      .modal select{width:100%;border:1px solid #ddd;border-radius:6px;padding:8px}
      .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
      .btn{padding:8px 12px;border-radius:6px;border:1px solid #ddd}
      .btn-primary{background:#1f6feb;color:#fff;border-color:#1f6feb}
    </style>
</head>
<body class="bg-gray-100 min-h-screen" style="margin:0;">
    {% include "_header.html" ignore missing %}
    <div id="arcadia-content">
    <div class="ui-section" style="margin:16px">
    <div class="max-w-md mx-auto mt-12 bg-white shadow p-6 rounded">
        <h1 class="text-2xl font-semibold mb-4">Create your account</h1>
        <form id="signup-form" class="space-y-4" onsubmit="return false;">
            <div>
                <label class="block text-sm mb-1">Email</label>
                <input id="email" type="email" class="w-full border rounded p-2" required />
            </div>
            <div>
                <label class="block text-sm mb-1">Password</label>
                <input id="password" type="password" class="w-full border rounded p-2" required />
                <div class="hint">At least 8 characters</div>
            </div>
            <button id="signup-btn" class="w-full bg-blue-600 text-white py-2 rounded">Sign up</button>
            <p id="signup-error" class="text-sm text-red-600 mt-2" style="display:none;"></p>
        </form>
    </div>
    <script>
    function extractErrorMessage(data, fallback) {
        if (!data) return fallback;
        const d = data.detail;
        if (typeof d === 'string') return d;
        if (Array.isArray(d) && d.length) {
            const first = d[0] || {};
            const loc = first.loc || [];
            if (loc.includes('password')) return 'Password must be at least 8 characters.';
            if (loc.includes('email')) return 'Please enter a valid email address.';
            return first.msg || fallback;
        }
        return fallback;
    }
    document.getElementById('signup-btn').addEventListener('click', async () => {
        const email = (document.getElementById('email').value || '').trim();
        const password = document.getElementById('password').value || '';
        const err = document.getElementById('signup-error');
        err.style.display = 'none';
        try {
            const res = await fetch('/auth/register', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email, password })
            });
            if (!res.ok) {
                const d = await res.json().catch(()=>null);
                throw new Error(extractErrorMessage(d, 'Sign up failed'));
            }
            const res2 = await fetch('/auth/login', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email, password })
            });
            if (!res2.ok) {
                const d2 = await res2.json().catch(()=>null);
                throw new Error(extractErrorMessage(d2, 'Login failed'));
            }
            const data = await res2.json();
            let access = '';
            try {
                access = data.access_token || '';
                if (access){
                  document.cookie = `access_token=${access}; Path=/; SameSite=Lax`;
                  localStorage.setItem('arcadia_access', access);
                }
            } catch {}
            // Show profile setup dialog before redirecting
            try {
              const bd = document.getElementById('profile-setup') as HTMLDivElement;
              if (bd) { bd.style.display = 'flex'; return; }
            } catch {}
            // Fallback to redirect if modal missing
            window.location.href = '/';
        } catch (e) {
            err.textContent = e.message || 'Sign up failed';
            err.style.display = 'block';
        }
    });
    </script>
    <!-- Profile setup modal -->
    <div id="profile-setup" class="modal-backdrop">
      <div class="modal">
        <h2>Set up your learning profile</h2>
        <div class="row">
          <label for="ps-lang">Which language are you learning?</label>
          <select id="ps-lang">
            <option value="zh">Chinese (zh)</option>
            <option value="es">Spanish (es)</option>
          </select>
        </div>
        <div class="row">
          <label for="ps-level">Estimate your current level (optional)</label>
          <select id="ps-level">
            <option value="">Skip</option>
            <option value="A0">Beginner (A0/A1)</option>
            <option value="A2">Elementary (A2)</option>
            <option value="B1">Intermediate (B1)</option>
            <option value="B2">Upper-Intermediate (B2)</option>
            <option value="C1">Advanced (C1/C2)</option>
          </select>
        </div>
        <div class="row">
          <label for="ps-target">Your interface/translation language</label>
          <select id="ps-target">
            <option value="en">English (en)</option>
            <option value="ru">Russian (ru)</option>
            <option value="de">German (de)</option>
          </select>
        </div>
        <div class="actions">
          <button id="ps-skip" class="btn">Skip</button>
          <button id="ps-create" class="btn btn-primary">Create profile</button>
        </div>
      </div>
    </div>
    <script>
      (function(){
        function closeAndGo(){ try{ document.getElementById('profile-setup').style.display='none'; }catch(e){} window.location.href = '/'; }
        function authHeader(){ try{ const t=localStorage.getItem('arcadia_access')||''; return t? { 'Authorization':'Bearer '+t } : {}; }catch(e){ return {}; } }
        const skip=document.getElementById('ps-skip');
        const create=document.getElementById('ps-create');
        skip && (skip.onclick=function(){ closeAndGo(); });
        create && (create.onclick = async function(){
          try{
            const lang = (document.getElementById('ps-lang').value||'zh');
            const lvl = (document.getElementById('ps-level').value||'');
            const tgt = (document.getElementById('ps-target').value||'en');
            const body = { lang: lang, target_lang: tgt };
            if (lvl) body.level_code = lvl;
            // Also persist the selected source language for immediate use in app
            try{ localStorage.setItem('arcadia_src', lang); }catch(e){}
            try{ localStorage.setItem('arcadia_tgt', tgt); }catch(e){}
            const res = await fetch('/me/profile', { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify(body) });
            // Ignore errors (user can set later)
          }catch(e){}
          closeAndGo();
        });
      })();
    </script>
    </div>
    </div>
</div>
</body>
</html>
