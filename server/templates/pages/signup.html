{% extends "layout/base.html" %}

{% block content %}
<div class="container mx-auto max-w-md p-4">
  <h1 class="text-2xl font-bold mb-6 text-center">Sign Up</h1>

  <form hx-post="/auth/register" hx-target="#signup-result" hx-ext="json-enc" hx-on--after-request="handleSignupResponse(event)" class="bg-white rounded-lg shadow-md p-6 space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
      <input type="email" name="email" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" required>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
      <input type="password" name="password" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" required>
    </div>

    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full transition-colors">
      Sign Up
    </button>

    <div class="text-center">
      <a href="/login" class="text-blue-600 hover:text-blue-700">Already have an account? Log in</a>
    </div>
  </form>

  <script>
  function handleSignupResponse(event) {
    if (event.detail.xhr.status === 201) {
      // Registration successful, now log in automatically
      const form = event.target;
      const formData = new FormData(form);
      const email = formData.get('email');
      const password = formData.get('password');

      // Call login endpoint
      fetch('/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, password })
      })
      .then(response => response.json())
      .then(data => {
        if (data.access_token) {
          document.cookie = `access_token=${data.access_token}; path=/; max-age=604800`;
          const resultDiv = document.getElementById('signup-result');
          resultDiv.innerHTML = `
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
              <strong>Success!</strong> Account created and logged in.
            </div>
          `;
          showProfileDialog();
        }
      })
      .catch(error => {
        console.error('Auto-login failed:', error);
        const resultDiv = document.getElementById('signup-result');
        resultDiv.innerHTML = `
          <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
            <strong>Success!</strong> Account created. Please <a href="/login" class="text-blue-600 hover:text-blue-700 underline">log in</a> to continue.
          </div>
        `;
      });
    }
  }

  function showProfileDialog() {
    const dlg = document.getElementById('profile-dialog');
    const langSelect = document.getElementById('profile-lang');
    const prefsInput = document.getElementById('profile-prefs');
    const createBtn = document.getElementById('profile-create');
    const skipBtn = document.getElementById('profile-skip');
    const statusEl = document.getElementById('profile-status');

    dlg.classList.remove('hidden');
    statusEl.textContent = '';
    prefsInput.value = '';
    langSelect.innerHTML = '<option value="" disabled selected>Loading languagesâ€¦</option>';

    const fallback = [
      { code: 'es', name: 'Spanish' },
      { code: 'zh-Hans', name: 'Chinese (Simplified)' },
      { code: 'zh-Hant', name: 'Chinese (Traditional)' },
    ];

    function populate(opts) {
      langSelect.innerHTML = '';
      for (const l of opts) {
        const opt = document.createElement('option');
        opt.value = l.code;
        opt.textContent = l.name || l.code;
        langSelect.appendChild(opt);
      }
      const hasEs = opts.find(o => o.code === 'es');
      langSelect.value = hasEs ? 'es' : (opts[0]?.code || 'es');
    }

    fetch('/languages')
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(data => {
        let langs = (data && Array.isArray(data.languages)) ? data.languages : [];
        // Ensure only es and zh variants appear
        langs = langs.filter(l => l.code === 'es' || l.code === 'zh-Hans' || l.code === 'zh-Hant');
        populate(langs.length ? langs : fallback);
      })
      .catch(() => populate(fallback));

    createBtn.onclick = () => {
      statusEl.textContent = '';
      const lang = langSelect.value;
      const text_preferences = prefsInput.value.trim();
      if (!lang) {
        statusEl.textContent = 'Please choose a language.';
        return;
      }
      createBtn.disabled = true;
      const payload = { target_lang: 'en', text_preferences };
      if (lang === 'zh-Hans') { payload.lang = 'zh'; payload.preferred_script = 'Hans'; }
      else if (lang === 'zh-Hant') { payload.lang = 'zh'; payload.preferred_script = 'Hant'; }
      else { payload.lang = lang; }

      fetch('/me/profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(r => {
        if (!r.ok) return r.json().then(j => Promise.reject(j));
        return r.json();
      })
      .then(() => {
        dlg.classList.add('hidden');
        window.location.href = '/';
      })
      .catch(err => {
        statusEl.textContent = (err && err.detail) ? err.detail : 'Failed to create profile.';
      })
      .finally(() => { createBtn.disabled = false; });
    };

    skipBtn.onclick = () => {
      dlg.classList.add('hidden');
      window.location.href = '/';
    };
  }
  </script>

  <div id="signup-result" class="mt-4">
    <!-- Signup result will appear here -->
  </div>

  <!-- Profile creation dialog -->
  <div id="profile-dialog" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
      <div class="p-6 border-b">
        <h2 class="text-xl font-bold">Set up your learning profile</h2>
        <p class="text-sm text-gray-600 mt-1">Choose your learning language and optionally describe preferred topics or styles.</p>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label for="profile-lang" class="block text-sm font-medium text-gray-700 mb-1">Learning Language</label>
          <select id="profile-lang" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
        </div>
        <div>
          <label for="profile-prefs" class="block text-sm font-medium text-gray-700 mb-1">Text Preferences (optional)</label>
          <textarea id="profile-prefs" rows="3" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., travel, daily life, technology, cultural topics"></textarea>
          <p id="profile-status" class="text-sm text-red-600 mt-2"></p>
        </div>
      </div>
      <div class="p-6 border-t flex items-center justify-end gap-2">
        <button id="profile-skip" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">Skip for now</button>
        <button id="profile-create" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Create Profile</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}