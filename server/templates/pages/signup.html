{% extends "layout/base.html" %}

{% block content %}
<div class="container mx-auto max-w-md p-4">
  <h1 class="text-2xl font-bold mb-6 text-center">Sign Up</h1>

  <form hx-post="/auth/register" hx-target="#signup-result" hx-ext="json-enc" hx-on--after-request="handleSignupResponse(event)" class="bg-white rounded-lg shadow-md p-6 space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
      <input type="email" name="email" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" required>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
      <input type="password" name="password" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" required>
    </div>

    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full transition-colors">
      Sign Up
    </button>

    <div class="text-center">
      <a href="/login" class="text-blue-600 hover:text-blue-700">Already have an account? Log in</a>
    </div>
  </form>

  <script>
  function handleSignupResponse(event) {
    if (event.detail.xhr.status === 201) {
      // Registration successful, now log in automatically
      const form = event.target;
      const formData = new FormData(form);
      const email = formData.get('email');
      const password = formData.get('password');

      // Call login endpoint
      fetch('/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, password })
      })
      .then(response => response.json())
      .then(data => {
        if (data.access_token) {
          // Set access token as cookie
          document.cookie = `access_token=${data.access_token}; path=/; max-age=604800`; // 7 days

          // Show success message
          const resultDiv = document.getElementById('signup-result');
          resultDiv.innerHTML = `
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
              <strong>Success!</strong> Account created and logged in. Redirecting...
            </div>
          `;

          // Redirect to home page after a short delay
          setTimeout(() => {
            window.location.href = '/';
          }, 1500);
        }
      })
      .catch(error => {
        console.error('Auto-login failed:', error);
        const resultDiv = document.getElementById('signup-result');
        resultDiv.innerHTML = `
          <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
            <strong>Success!</strong> Account created. Please <a href="/login" class="text-blue-600 hover:text-blue-700 underline">log in</a> to continue.
          </div>
        `;
      });
    }
  }
  </script>

  <div id="signup-result" class="mt-4">
    <!-- Signup result will appear here -->
  </div>
</div>
{% endblock %}