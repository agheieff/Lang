{% extends "layout/base.html" %}

{% block content %}
<div class="container mx-auto max-w-2xl p-4">
  <h1 class="text-2xl font-bold mb-6">Settings</h1>

  <!-- Subscription Tier Section -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">Subscription & Usage</h2>
    <div id="tier-section" hx-get="/settings/tier" hx-trigger="load" hx-select="unset">
      <div class="animate-pulse space-y-3">
        <div class="h-8 bg-gray-100 rounded w-1/3"></div>
        <div class="h-20 bg-gray-100 rounded"></div>
      </div>
    </div>
  </div>

  <!-- Profile Settings Section -->
  {% if current_profile %}
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">Language Learning Preferences</h2>
    <p class="text-gray-600 mb-6">Configure your preferences for reading generation and content selection.</p>

    <!-- Text Length Field -->
    <div class="mb-6">
      <label for="text-length" class="block text-sm font-medium text-gray-700 mb-2">
        Preferred Reading Length
      </label>
      <input
        type="number"
        id="text-length"
        name="text-length"
        min="50"
        max="2000"
        value="{{ current_profile.text_length or 300 }}"
        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        hx-put="/me/profile?lang={{ current_profile.lang }}&target_lang={{ current_profile.target_lang }}"
        hx-trigger="change delay:500ms"
        hx-ext="json-enc"
        hx-on--config-request="(function(){try{var el=event.detail&&event.detail.elt?event.detail.elt:null;var raw=el&&('value'in el)?el.value:null;var n=parseInt(raw,10);if(!isFinite(n)) n=null;event.detail.headers=event.detail.headers||{};event.detail.headers['Content-Type']='application/json';event.detail.parameters={text_length: n};}catch(e){}})()"
        hx-target="#length-status"
        hx-swap="innerHTML"
      >
      <div id="length-status" class="mt-2 text-sm text-gray-500"></div>
      <p class="mt-1 text-sm text-gray-500">
        Target length in {{ 'characters' if current_profile.lang and current_profile.lang.startswith('zh') else 'words' }} (50-2000 {{ 'characters' if current_profile.lang and current_profile.lang.startswith('zh') else 'words' }}). Shorter texts are easier for beginners.
      </p>
    </div>

    <!-- Language Level Display -->
    <div class="mb-6">
      <h3 class="text-lg font-medium text-gray-900 mb-2">Current Language Level</h3>
      <div class="flex items-center space-x-4">
        <div class="flex-1">
          <div class="flex justify-between text-sm text-gray-600 mb-1">
            <span>Estimated Level</span>
            <span>{{ "%.1f"|format(current_profile.level_value) if current_profile.level_value else '0.0' }}/10.0</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div
              class="bg-blue-600 h-2 rounded-full transition-all duration-300"
              style="width: {{ (current_profile.level_value / 10 * 100) if current_profile.level_value else 0 }}%"
            ></div>
          </div>
        </div>
        {% if current_profile.level_code %}
        <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
          {{ current_profile.level_code }}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Profile Information -->
    <div class="border-t border-gray-200 pt-4">
      <h3 class="text-lg font-medium text-gray-900 mb-2">Profile Information</h3>
      <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <dt class="text-sm font-medium text-gray-500">Learning Language</dt>
          <dd class="text-sm text-gray-900">{{ current_profile.lang }}</dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Target Language</dt>
          <dd class="text-sm text-gray-900">{{ current_profile.target_lang }}</dd>
        </div>
        {% if current_profile.preferred_script %}
        <div>
          <dt class="text-sm font-medium text-gray-500">Preferred Script</dt>
          <dd class="text-sm text-gray-900">{{ current_profile.preferred_script }}</dd>
        </div>
        {% endif %}
        <div>
          <dt class="text-sm font-medium text-gray-500">Created</dt>
          <dd class="text-sm text-gray-900">{{ current_profile.created_at.strftime('%Y-%m-%d') }}</dd>
        </div>
      </dl>
    </div>
  </div>

  <!-- Topic Interests Section -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-bold mb-2">Reading Preferences</h2>
    <p class="text-gray-600 mb-4">Current topic weights and reading length. Use the message box below to adjust.</p>

    <!-- Current topics display -->
    <div id="topics-section" hx-get="/settings/topics" hx-trigger="load" hx-select="unset">
      <div class="animate-pulse space-y-3">
        <div class="h-8 bg-gray-100 rounded w-1/4"></div>
        <div class="flex gap-2">
          <div class="h-8 bg-gray-100 rounded-full w-20"></div>
          <div class="h-8 bg-gray-100 rounded-full w-24"></div>
          <div class="h-8 bg-gray-100 rounded-full w-16"></div>
        </div>
      </div>
    </div>

    <!-- Preferences update via chat -->
    <div class="mt-6 border-t pt-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Update Preferences</label>
      <p class="text-sm text-gray-500 mb-3">
        Describe what you want to change. Examples: "I'm interested in technology and science",
        "Make texts shorter", "Less news, more fiction", "I want to read about Chinese history and culture"
      </p>
      <div class="flex gap-2">
        <input
          type="text"
          id="preferences-message"
          class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="e.g., More technology topics, shorter texts..."
        >
        <button
          type="button"
          id="update-preferences-btn"
          onclick="updatePreferencesViaChat()"
          class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Update
        </button>
      </div>
      <div id="preferences-update-status" class="mt-2 text-sm"></div>
    </div>
  </div>

  <script>
  let prefsPolling = null;
  let wasPolling = false;  // Track if we were actually polling

  async function checkPrefsStatus() {
    const btn = document.getElementById('update-preferences-btn');
    const status = document.getElementById('preferences-update-status');
    const input = document.getElementById('preferences-message');

    try {
      const resp = await fetch('/settings/preferences/status');
      const data = await resp.json();

      if (data.updating) {
        // Still updating, keep polling
        wasPolling = true;
        btn.disabled = true;
        btn.textContent = 'Updating...';
        status.textContent = 'Processing your request...';
        status.className = 'mt-2 text-sm text-gray-500';
        return true;
      } else {
        // Done updating
        btn.disabled = false;
        btn.textContent = 'Update';

        // Only show success if we were actually polling
        if (wasPolling) {
          wasPolling = false;
          status.textContent = 'Preferences updated!';
          status.className = 'mt-2 text-sm text-green-600';
          input.value = '';

          // Reload topics section
          const topicsSection = document.getElementById('topics-section');
          if (topicsSection) {
            const topicsResp = await fetch('/settings/topics');
            topicsSection.innerHTML = await topicsResp.text();
            htmx.process(topicsSection);
          }

          // Update text length
          if (data.text_length !== undefined) {
            const lengthInput = document.getElementById('text-length');
            if (lengthInput) lengthInput.value = data.text_length;
          }
        }
        return false;
      }
    } catch (e) {
      btn.disabled = false;
      btn.textContent = 'Update';
      return false;
    }
  }

  function startPrefsPolling() {
    wasPolling = true;  // We started an update
    if (prefsPolling) clearInterval(prefsPolling);
    prefsPolling = setInterval(async () => {
      const stillUpdating = await checkPrefsStatus();
      if (!stillUpdating && prefsPolling) {
        clearInterval(prefsPolling);
        prefsPolling = null;
      }
    }, 1500);
  }

  async function updatePreferencesViaChat() {
    const input = document.getElementById('preferences-message');
    const btn = document.getElementById('update-preferences-btn');
    const status = document.getElementById('preferences-update-status');
    const message = (input.value || '').trim();

    if (!message) {
      status.textContent = 'Please enter a message';
      status.className = 'mt-2 text-sm text-red-500';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Updating...';
    status.textContent = 'Processing your request...';
    status.className = 'mt-2 text-sm text-gray-500';

    try {
      const resp = await fetch('/settings/preferences/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message })
      });

      const data = await resp.json();

      if (resp.ok && data.success) {
        if (data.status === 'updating') {
          // Start polling for completion
          startPrefsPolling();
        } else {
          // Immediate completion (shouldn't happen with async)
          status.textContent = data.message || 'Preferences updated!';
          status.className = 'mt-2 text-sm text-green-600';
          btn.disabled = false;
          btn.textContent = 'Update';
          input.value = '';
        }
      } else {
        status.textContent = data.error || 'Failed to update preferences';
        status.className = 'mt-2 text-sm text-red-500';
        btn.disabled = false;
        btn.textContent = 'Update';
      }
    } catch (e) {
      status.textContent = 'Error: ' + e.message;
      status.className = 'mt-2 text-sm text-red-500';
      btn.disabled = false;
      btn.textContent = 'Update';
    }
  }

  // Check on page load if an update is in progress
  document.addEventListener('DOMContentLoaded', async () => {
    const stillUpdating = await checkPrefsStatus();
    if (stillUpdating) startPrefsPolling();
  });
  </script>
  {% else %}
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-bold mb-2">Language Learning Preferences</h2>
    <p class="text-gray-600">No profile found. Create one on the <a href="/profile" class="text-blue-600 underline">Profile</a> page to configure preferences.</p>
  </div>
  {% endif %}
</div>

<script>
function setupFormFeedback() {
  htmx.on('htmx:afterRequest', function(evt) {
    const target = evt.detail.target;
    if (target && evt.detail.xhr.status === 200) {
      if (target.id === 'preferences-status' || target.id === 'length-status') {
        target.innerHTML = '<span class="text-green-600">Saved</span>';
        setTimeout(() => { target.innerHTML = ''; }, 3000);
      }
    } else if (target && evt.detail.xhr.status !== 200) {
      if (target.id === 'preferences-status' || target.id === 'length-status') {
        target.innerHTML = '<span class="text-red-600">Failed to save</span>';
        setTimeout(() => { target.innerHTML = ''; }, 3000);
      }
    }
  });
}

document.addEventListener('DOMContentLoaded', setupFormFeedback);
</script>
{% endblock %}
