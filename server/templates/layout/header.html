<header class="bg-gradient-to-b from-gray-900 to-gray-800 text-white shadow-lg sticky top-0 z-50">
  <div class="container mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center space-x-6">
      <a class="text-xl font-bold hover:text-blue-300 transition-colors" href="/">
        Arcadia Lang
      </a>

      {% if request.state.user and current_profile %}
      <!-- Profile Switcher -->
      <div class="relative">
        <button class="flex items-center space-x-2 px-3 py-2 rounded-lg border border-gray-600 bg-gray-800 hover:bg-gray-700 transition-colors" onclick="toggleProfileMenu()">
          <span id="current-profile-flag"></span>
          <span id="current-profile-name">Loading...</span>
          <span>▾</span>
          </button>
          <div class="absolute left-0 top-full mt-2 w-56 bg-white text-gray-800 rounded-lg shadow-lg border border-gray-200 py-2 hidden" id="profile-menu">
            <div id="profile-list" class="max-h-64 overflow-y-auto">
              <!-- Profiles will be loaded here -->
            </div>
            <hr class="my-2" />
            <a href="/profile" class="block px-4 py-2 hover:bg-gray-100 text-blue-600">
              + Add new profile
            </a>
          </div>
        </div>
      {% endif %}
    </div>

    <div class="flex items-center space-x-6">
      {% if request.state.user %}
      <nav class="flex space-x-4" aria-label="Primary">
        <a href="/reading" class="hover:text-blue-300 transition-colors">Practice</a>
        <a href="/words" class="hover:text-blue-300 transition-colors">Words</a>
        <a href="/stats" class="hover:text-blue-300 transition-colors">Stats</a>
      </nav>

      <div class="relative">
        <button class="flex items-center space-x-2 px-3 py-2 rounded-lg border border-gray-600 bg-gray-800 hover:bg-gray-700 transition-colors" onclick="toggleUserMenu()">
          <span>Account</span>
          <span>▾</span>
        </button>
        <div class="absolute right-0 top-full mt-2 w-48 bg-white text-gray-800 rounded-lg shadow-lg border border-gray-200 py-2 hidden" id="user-menu">
          <a href="/profile" class="block px-4 py-2 hover:bg-gray-100">Profile</a>
          <a href="/settings" class="block px-4 py-2 hover:bg-gray-100">Settings</a>
          {% if request.state.user and request.state.user.subscription_tier in ['admin', 'system'] %}
          <a href="/admin/texts" class="block px-4 py-2 hover:bg-gray-100 text-purple-600">Admin: Texts</a>
          <a href="/admin/accounts" class="block px-4 py-2 hover:bg-gray-100 text-purple-600">Admin: Accounts</a>
          {% endif %}
          <hr class="my-2" />
          <a href="/auth/logout" class="block px-4 py-2 hover:bg-gray-100">Log out</a>
        </div>
      </div>
      {% else %}
      <div class="flex space-x-3">
        <a href="/login" class="px-4 py-2 border border-gray-600 rounded-lg hover:bg-gray-700 transition-colors">Log in</a>
        <a href="/signup" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">Sign up</a>
      </div>
      {% endif %}
    </div>
  </div>
</header>

{% if request.state.user %}
<script>
// Profile management
let currentProfileId = null;
let profiles = [];

async function loadProfiles() {
  try {
    // Fetch current profile ID first
    const profileResponse = await fetch('/profile/api');
    if (profileResponse.ok) {
      const profileData = await profileResponse.json();
      currentProfileId = profileData.id;
    }

    // Then fetch all profiles
    const response = await fetch('/profile/list');
    const data = await response.json();

    if (data.profiles && data.profiles.length > 0) {
      profiles = data.profiles;

      // Find current profile
      const currentProfile = profiles.find(p => p.id === currentProfileId);

      // Update button
      if (currentProfile) {
        document.getElementById('current-profile-flag').textContent = currentProfile.flag;
        document.getElementById('current-profile-name').textContent = currentProfile.name;
      } else if (profiles.length > 0) {
        // Fallback to first profile
        const firstProfile = profiles[0];
        document.getElementById('current-profile-flag').textContent = firstProfile.flag;
        document.getElementById('current-profile-name').textContent = firstProfile.name;
        currentProfileId = firstProfile.id;
      }

      // Populate dropdown
      const profileList = document.getElementById('profile-list');
      profileList.innerHTML = profiles.map(p => `
        <button
          onclick="switchProfile(${p.id})"
          class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center justify-between ${p.id === currentProfileId ? 'bg-blue-50' : ''}"
        >
          <span>${p.flag} ${p.name}</span>
          ${p.id === currentProfileId ? '<span class="text-blue-600">✓</span>' : ''}
        </button>
      `).join('');
    }
  } catch (error) {
    console.error('Failed to load profiles:', error);
    document.getElementById('current-profile-name').textContent = 'Error';
  }
}

async function switchProfile(profileId) {
  if (profileId === currentProfileId) {
    // Already on this profile, just close menu
    document.getElementById('profile-menu').classList.add('hidden');
    return;
  }

  try {
    const response = await fetch('/profile/switch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ profile_id: profileId })
    });

    if (response.ok) {
      // Immediate redirect to reading page to ensure fresh state
      window.location.href = '/reading';
    }
  } catch (error) {
    console.error('Failed to switch profile:', error);
  }
}

function toggleProfileMenu() {
  const menu = document.getElementById('profile-menu');
  menu.classList.toggle('hidden');
}

function toggleUserMenu() {
  const menu = document.getElementById('user-menu');
  menu.classList.toggle('hidden');
}

// Close menus when clicking outside
document.addEventListener('click', function(event) {
  const profileMenu = document.getElementById('profile-menu');
  const userMenu = document.getElementById('user-menu');
  const profileBtn = document.querySelector('button[onclick="toggleProfileMenu()"]');
  const userBtn = document.querySelector('button[onclick="toggleUserMenu()"]');

  if (profileMenu && profileBtn && !profileBtn.contains(event.target) && !profileMenu.contains(event.target)) {
    profileMenu.classList.add('hidden');
  }

  if (userMenu && userBtn && !userBtn.contains(event.target) && !userMenu.contains(event.target)) {
    userMenu.classList.add('hidden');
  }
});

// Load profiles on page ready
loadProfiles();
</script>
{% else %}
<script>
function toggleUserMenu() {
  const menu = document.getElementById('user-menu');
  menu.classList.toggle('hidden');
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
  const menu = document.getElementById('user-menu');
  const menuBtn = document.querySelector('button[onclick="toggleUserMenu()"]');
  if (menu && menuBtn && !menuBtn.contains(event.target) && !menuMenu.contains(event.target)) {
    menu.classList.add('hidden');
  }
});
</script>
{% endif %}
