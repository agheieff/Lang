{% extends "_content_wrapper.html" %}

{% block content %}
<div class="t-container t-mx-auto t-max-w-4xl t-p-4">
  <div class="t-flex t-items-center t-gap-2 t-mb-4">
    <h2 class="t-text-2xl t-font-bold">My Words</h2>
    <span id="count" class="t-badge t-badge-outline">0</span>
  </div>

  <div class="t-card t-p-4 t-mb-4">
    <div class="t-flex t-flex-wrap t-gap-4 t-items-center">
      <label class="t-flex t-items-center t-gap-2 t-cursor-pointer">
        <input id="hide-new" type="checkbox" class="t-checkbox" />
        <span class="t-text-sm">Hide not yet learned words</span>
      </label>
      <label class="t-flex t-items-center t-gap-2">
        <span class="t-text-sm">Min stability</span>
        <input id="min-stab" type="number" step="0.01" min="0" max="1" class="t-input t-input-sm t-w-20" placeholder="0.0"/>
      </label>
      <input id="q" class="t-input t-input-sm t-w-48" placeholder="Search lemma" />
      <a class="t-btn t-btn-sm t-btn-outline" href="/">Back</a>
    </div>
  </div>

  <div class="t-card t-overflow-hidden">
    <div class="t-overflow-auto t-max-h-96">
      <table id="tbl" class="t-table t-table-zebra t-table-sm t-w-full">
        <thead class="t-sticky t-top-0 t-bg-base-100">
          <tr>
            <th>Lemma</th>
            <th>Freq</th>
            <th>Level</th>
            <th>P(click)</th>
            <th>N</th>
            <th>Stability</th>
            <th>Diversity</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
async function loadWords(){
  const params = new URLSearchParams(window.location.search);
  const lang = params.get('lang') || localStorage.getItem('arcadia_src') || 'zh';
  const hideNew = document.getElementById('hide-new').checked;
  const minS = document.getElementById('min-stab').value;
  const search = document.getElementById('q').value.trim().toLowerCase();
  const url = new URL('/srs/words', window.location.origin);
  url.searchParams.set('lang', lang);
  if (minS) url.searchParams.set('min_S', minS);
  const res = await fetch(url.toString(), { headers: authHeader() });
  const tbl = document.getElementById('tbl');
  const tbody = document.getElementById('tbody');
  const cnt = document.getElementById('count');
  tbody.innerHTML = '';
  if (!res.ok) { tbody.innerHTML = '<tr><td colspan="9">Login required</td></tr>'; return; }
  const rows = await res.json();
  let items = rows;
  if (hideNew) items = items.filter(r => (r.n||0) > 0);
  if (search) items = items.filter(r => (r.lemma||'').toLowerCase().includes(search));
  cnt.textContent = String(items.length);
  for (const r of items){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-context-menu="word" data-lang="${lang}" data-lemma="${r.lemma||''}" data-pos="${r.pos||''}">
        <strong>${r.lemma}</strong>${r.pos?` <span class="t-text-base-content/70">(${r.pos})</span>`:''}
      </td>
      <td>${r.freq_rank ?? ''}</td>
      <td>${r.level_code ?? ''}</td>
      <td>${r.p_click.toFixed(2)}</td>
      <td>${r.n}</td>
      <td>${r.stability.toFixed(2)}</td>
      <td>${r.diversity}</td>
      <td><button class="t-btn t-btn-xs t-btn-outline" onclick="markKnown('${lang}','${r.lemma||''}','${r.pos||''}')">Hide (known)</button></td>
    `;
    tbody.appendChild(tr);
  }
}
function authHeader(){
  const t = localStorage.getItem('arcadia_access')||'';
  return t? { 'Authorization': 'Bearer '+t } : {};
}
async function markKnown(lang, lemma, pos){
  try{
    const body = { lang, items:[{ lemma, pos: pos||null }] };
    await fetch('/srs/event/nonlookup', { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify(body) });
    loadWords();
  }catch(e){}
}
function init(){
  document.getElementById('hide-new').addEventListener('change', loadWords);
  document.getElementById('min-stab').addEventListener('change', loadWords);
  document.getElementById('q').addEventListener('input', () => { clearTimeout(window._qto); window._qto=setTimeout(loadWords, 200); });
  loadWords();
}
window.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}