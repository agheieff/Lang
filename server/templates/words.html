<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Words</title>
    <link rel="stylesheet" href="/arcadia.css" />
    <style>
      .wrap{max-width:1000px;margin:0 auto;padding:12px}
      table{width:100%;border-collapse:collapse}
      th,td{padding:6px 8px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
      th{position:sticky;top:0;background:#fafafa;z-index:1}
      .controls{display:flex;gap:8px;align-items:center;margin:10px 0}
      .badge{padding:2px 6px;border:1px solid #ddd;border-radius:10px;font-size:12px;color:#555}
      .pill{padding:2px 6px;border-radius:12px;font-size:12px;background:#eef}
      .muted{color:#888}
      .grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
      .search{width:200px}
    </style>
    <script>
    async function loadWords(){
      const params = new URLSearchParams(window.location.search);
      const lang = params.get('lang') || localStorage.getItem('arcadia_src') || 'es';
      const hideNew = document.getElementById('hide-new').checked;
      const minS = document.getElementById('min-stab').value;
      const search = document.getElementById('q').value.trim().toLowerCase();
      const url = new URL('/srs/words', window.location.origin);
      url.searchParams.set('lang', lang);
      if (minS) url.searchParams.set('min_S', minS);
      const res = await fetch(url.toString(), { headers: authHeader() });
      const tbl = document.getElementById('tbl');
      const tbody = document.getElementById('tbody');
      const cnt = document.getElementById('count');
      tbody.innerHTML = '';
      if (!res.ok) { tbody.innerHTML = '<tr><td colspan="9">Login required</td></tr>'; return; }
      const rows = await res.json();
      let items = rows;
      if (hideNew) items = items.filter(r => (r.n||0) > 0);
      if (search) items = items.filter(r => (r.lemma||'').toLowerCase().includes(search));
      cnt.textContent = String(items.length);
      for (const r of items){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${r.lemma}</strong>${r.pos?` <span class="muted">(${r.pos})</span>`:''}</td>
          <td>${r.freq_rank ?? ''}</td>
          <td>${r.level_code ?? ''}</td>
          <td>${r.p_click.toFixed(2)}</td>
          <td>${r.n}</td>
          <td>${r.stability.toFixed(2)}</td>
          <td>${r.diversity}</td>
          <td><button class="pill" onclick="markKnown('${lang}','${r.lemma||''}','${r.pos||''}')">Hide (known)</button></td>
        `;
        tbody.appendChild(tr);
      }
    }
    function authHeader(){
      const t = localStorage.getItem('arcadia_access')||'';
      return t? { 'Authorization': 'Bearer '+t } : {};
    }
    async function markKnown(lang, lemma, pos){
      try{
        const body = { lang, items:[{ lemma, pos: pos||null }] };
        await fetch('/srs/event/nonlookup', { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify(body) });
        loadWords();
      }catch(e){}
    }
    function init(){
      document.getElementById('hide-new').addEventListener('change', loadWords);
      document.getElementById('min-stab').addEventListener('change', loadWords);
      document.getElementById('q').addEventListener('input', () => { clearTimeout(window._qto); window._qto=setTimeout(loadWords, 200); });
      loadWords();
    }
    window.addEventListener('DOMContentLoaded', init);
    </script>
  </head>
  <body>
    <div id="ui-header"></div>
    <div class="wrap">
      <h2 style="margin:4px 0 10px">My Words <span id="count" class="badge">0</span></h2>
      <div class="controls">
        <label><input id="hide-new" type="checkbox" /> hide not yet learned words</label>
        <label>min stability <input id="min-stab" type="number" step="0.01" min="0" max="1" style="width:80px" placeholder="0.0"/></label>
        <input id="q" class="search" placeholder="search lemma" />
        <a class="badge" href="/">Back</a>
      </div>
      <div style="overflow:auto; max-height:70vh; border:1px solid #eee; border-radius:6px">
        <table id="tbl">
          <thead>
            <tr>
              <th>Lemma</th>
              <th>Freq</th>
              <th>Level</th>
              <th>P(click)</th>
              <th>N</th>
              <th>Stability</th>
              <th>Diversity</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
    <div id="ui-footer"></div>
    <script>
      fetch('/ui/header').then(r=>r.text()).then(html=>{ document.getElementById('ui-header').innerHTML = html; }).catch(()=>{});
      fetch('/ui/footer').then(r=>r.text()).then(html=>{ document.getElementById('ui-footer').innerHTML = html; }).catch(()=>{});
    </script>
  </body>
  </html>
